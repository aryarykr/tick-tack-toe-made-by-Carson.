<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Tic Tac Toe + Shop</title>
<style>
  body {
    font-family: sans-serif;
    margin: 0;
    text-align: center;
    background: #f7f7f7;
    color: #000;
    user-select: none;
  }
  #ui {
    position: fixed;
    top: 0; left: 0; right: 0;
    background: white;
    padding: 10px;
    border-bottom: 1px solid #ccc;
    z-index: 10;
  }
  #currency {
    font-weight: bold;
    margin-top: 5px;
  }
  #tttGame {
    padding-top: 90px;
  }
  #board {
    width: 306px;
    margin: 20px auto;
    display: flex;
    flex-wrap: wrap;
  }
  .cell {
    width: 100px;
    height: 100px;
    border: 1px solid black;
    font-size: 60px;
    line-height: 100px;
    cursor: pointer;
    position: relative;
  }
  .cell.highlight {
    background-color: yellow;
  }
  #tttStatus {
    height: 30px;
    font-size: 18px;
    margin: 10px 0;
  }
  #shop {
    max-width: 350px;
    margin: 20px auto;
    text-align: left;
  }
  .shopItem {
    padding: 8px;
    border-bottom: 1px solid #ccc;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .shopItem button {
    padding: 5px 10px;
    cursor: pointer;
  }
  button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  #modeButtons button {
    margin: 0 5px;
    padding: 8px 12px;
    cursor: pointer;
  }
</style>
</head>
<body>

<div id="ui">
  <div id="modeButtons">
    <button onclick="setMode('friend')">Play vs Friend</button>
    <button onclick="setMode('bot')">Play vs Bot</button>
    <button onclick="setMode('botvsbot')">Bot vs Bot</button>
  </div>
  <div id="currency">Dab Cones: 0</div>
</div>

<div id="tttGame">
  <h1>Tic Tac Toe</h1>
  <div id="board"></div>
  <div id="tttStatus"></div>
  <div id="shop"></div>
</div>

<script>
let board = [];
let currentTurn = 'X';
let mode = 'friend';
let gameOver = false;
let cones = 0;

// Shop Items: add as needed
let shopItems = [
  { name: "Win Bonus", cost: 50, bought: false, roundsLeft: 2 }, // doubles win cones for 2 rounds
  { name: "Extra Move", cost: 80, bought: false, roundsLeft: 2 }, // lets player move twice
  { name: "Faster Bot", cost: 70, bought: false, roundsLeft: 2 }, // bot moves faster
  { name: "Flash Screen", cost: 90, bought: false, roundsLeft: 1 }, // screen flash effect
  { name: "Smart Bot", cost: 150, bought: false, roundsLeft: 2 } // perfect bot logic
];

let extraMoveActive = false;
let movesMadeThisTurn = 0;

function updateCurrency() {
  document.getElementById('currency').textContent = `Dab Cones: ${cones}`;
}

function setMode(m) {
  mode = m;
  startGame();
}

function startGame() {
  board = Array(9).fill('');
  currentTurn = 'X';
  gameOver = false;
  extraMoveActive = shopItems[1].bought && shopItems[1].roundsLeft > 0;
  movesMadeThisTurn = 0;
  renderBoard();
  updateStatus(`Turn: ${currentTurn}`);
  renderShop();
  updateCurrency();

  if (mode === 'botvsbot') botVsBot();
  else if (mode === 'bot' && currentTurn === 'O') {
    setTimeout(botMove, getBotSpeed());
  }
}

function renderBoard() {
  const boardDiv = document.getElementById('board');
  boardDiv.innerHTML = '';
  board.forEach((cell, idx) => {
    const div = document.createElement('div');
    div.className = 'cell';
    div.textContent = cell;
    div.onclick = () => handleClick(idx);
    boardDiv.appendChild(div);
  });
}

function handleClick(i) {
  if (gameOver || board[i]) return;
  if (mode === 'botvsbot') return;
  if (mode === 'bot' && currentTurn === 'O') return;

  board[i] = currentTurn;
  movesMadeThisTurn++;
  renderBoard();
  checkGameEnd();

  if (gameOver) return;

  if (extraMoveActive && movesMadeThisTurn < 2 && currentTurn === 'X' && mode === 'bot') {
    updateStatus(`Extra move! Turn: ${currentTurn}`);
    return;
  }

  movesMadeThisTurn = 0;
  currentTurn = currentTurn === 'X' ? 'O' : 'X';
  updateStatus(`Turn: ${currentTurn}`);

  if (mode === 'bot' && currentTurn === 'O') {
    setTimeout(botMove, getBotSpeed());
  }
}

function updateStatus(text) {
  document.getElementById('tttStatus').textContent = text;
}

function checkGameEnd() {
  const wins = [
    [0,1,2],[3,4,5],[6,7,8],
    [0,3,6],[1,4,7],[2,5,8],
    [0,4,8],[2,4,6]
  ];
  for (let combo of wins) {
    const [a, b, c] = combo;
    if (board[a] && board[a] === board[b] && board[b] === board[c]) {
      highlightCells(combo);
      updateStatus(`${board[a]} Wins!`);
      gameOver = true;

      if (mode === 'bot') {
        if (board[a] === 'X') {
          let reward = shopItems[0].bought && shopItems[0].roundsLeft > 0 ? 200 : 100;
          cones += reward;
          if (shopItems[0].bought && shopItems[0].roundsLeft > 0) shopItems[0].roundsLeft--;
        } else if (board[a] === 'O') {
          cones -= 100;
          if (cones < 0) cones = 0;
        }
      }

      shopItems.forEach(item => {
        if (item.bought && item.roundsLeft !== undefined && item.roundsLeft > 0) {
          item.roundsLeft--;
          if (item.roundsLeft <= 0) {
            item.bought = false;
            alert(`${item.name} effect has expired!`);
          }
        }
      });

      updateCurrency();
      renderShop();

      if (shopItems[3].bought) flashScreen(10);

      setTimeout(startGame, 2000);
      return;
    }
  }

  if (!board.includes('')) {
    updateStatus('Draw!');
    gameOver = true;
    setTimeout(startGame, 2000);
  }
}

function highlightCells(cells) {
  const cellDivs = document.querySelectorAll('.cell');
  cells.forEach(i => cellDivs[i].classList.add('highlight'));
}

function getBotSpeed() {
  return shopItems[2].bought && shopItems[2].roundsLeft > 0 ? 200 : 500;
}

function botMove() {
  if (gameOver) return;
  let empty = board.map((v, i) => v === '' ? i : null).filter(v => v !== null);
  if (empty.length === 0) return;

  if (shopItems[4].bought && shopItems[4].roundsLeft > 0) {
    let move = findBestMove(board, 'O');
    if (move !== null) {
      board[move] = 'O';
      renderBoard();
      checkGameEnd();
      if (!gameOver) {
        currentTurn = 'X';
        updateStatus(`Turn: ${currentTurn}`);
      }
      return;
    }
  }

  let move = empty[Math.floor(Math.random() * empty.length)];
  board[move] = 'O';
  renderBoard();
  checkGameEnd();

  if (!gameOver) {
    currentTurn = 'X';
    updateStatus(`Turn: ${currentTurn}`);
  }
}

function botVsBot() {
  if (gameOver) {
    setTimeout(startGame, 1000);
    return;
  }
  let empty = board.map((v, i) => v === '' ? i : null).filter(v => v !== null);
  if (empty.length === 0) return;
  let move = empty[Math.floor(Math.random() * empty.length)];
  board[move] = currentTurn;
  renderBoard();
  checkGameEnd();

  if (!gameOver) {
    currentTurn = currentTurn === 'X' ? 'O' : 'X';
    updateStatus(`Turn: ${currentTurn}`);
    setTimeout(botVsBot, getBotSpeed());
  }
}

function renderShop() {
  const shop = document.getElementById('shop');
  shop.innerHTML = "<h3>Shop</h3>";
  shopItems.forEach((item, idx) => {
    const isDisabled = item.bought;
    const roundsText = item.bought && item.roundsLeft !== undefined ? ` (Rounds left: ${item.roundsLeft})` : '';
    const buttonText = isDisabled ? "Owned" : "Buy";
    const buttonDisabledAttr = isDisabled ? "disabled" : "";
    const div = document.createElement('div');
    div.className = 'shopItem';
    div.innerHTML = `
      <span>${item.name} (${item.cost} cones)${roundsText}</span>
      <button ${buttonDisabledAttr} onclick="buyItem(${idx})">${buttonText}</button>
    `;
    shop.appendChild(div);
  });
}

function buyItem(i) {
  const item = shopItems[i];
  if (cones >= item.cost && !item.bought) {
    cones -= item.cost;
    item.bought = true;
    item.roundsLeft = item.roundsLeft || 2;
    updateCurrency();
    renderShop();
    alert(`You bought ${item.name}!`);
  } else if (item.bought) {
    alert(`You already own ${item.name}.`);
  } else {
    alert(`Not enough Dab Cones to buy ${item.name}.`);
  }
}

function findBestMove(board, player) {
  const opponent = player === 'X' ? 'O' : 'X';
  const wins = [
    [0,1,2],[3,4,5],[6,7,8],
    [0,3,6],[1,4,7],[2,5,8],
    [0,4,8],[2,4,6]
  ];

  for (let combo of wins) {
    let marks = combo.map(i => board[i]);
    if (marks.filter(m => m === player).length === 2 && marks.includes('')) {
      return combo[marks.indexOf('')];
    }
  }

  for (let combo of wins) {
    let marks = combo.map(i => board[i]);
    if (marks.filter(m => m === opponent).length === 2 && marks.includes('')) {
      return combo[marks.indexOf('')];
    }
  }
  return null;
}

function flashScreen(seconds) {
  let elapsed = 0;
  const interval = 500; // 0.5 sec
  const colors = ['red','orange','yellow','green','blue','indigo','violet','pink','cyan','lime'];
  const flashDiv = document.createElement('div');
  flashDiv.style.position = 'fixed';
  flashDiv.style.top = 0;
  flashDiv.style.left = 0;
  flashDiv.style.width = '100%';
  flashDiv.style.height = '100%';
  flashDiv.style.zIndex = 9999;
  flashDiv.style.opacity = 0.7;
  document.body.appendChild(flashDiv);

  const flashInterval = setInterval(() => {
    flashDiv.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
    elapsed += interval;
    if (elapsed >= seconds * 1000) {
      clearInterval(flashInterval);
      document.body.removeChild(flashDiv);
    }
  }, interval);
}

startGame();
</script>
</body>
</html>

